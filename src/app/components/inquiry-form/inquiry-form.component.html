<section class="flex justify-center items-center mt-4">
  <form [formGroup]="inquiryForm" class="p-6 shadow-md rounded max-w-4xl border mb-4">
    <!-- Basic Information Section -->
    <section class="mb-6">
      <h3 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Basic Information</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <p-float-label variant="on">
          <p-date-picker inputId="date" formControlName="date" [showIcon]="true" dateFormat="mm-dd-yy"
                         fluid></p-date-picker>
          <label for="date">Date</label>
        </p-float-label>

        <p-float-label variant="on">
          <input pInputText type="text" id="clientName" formControlName="clientName" class="w-full">
          <label for="clientName">Client Name</label>
        </p-float-label>
      </div>

      <div class="mt-4">
        <label class="text-gray-700 font-semibold block mb-2">Contact Point</label>
        <div class="flex flex-wrap items-center gap-4">
          <div class="flex items-center">
            <p-radio-button value="fb" formControlName="contactPoint" inputId="contactPointFB"/>
            <label for="contactPointFB" class="ml-2">Facebook</label>
          </div>
          <div class="flex items-center">
            <p-radio-button value="pm" formControlName="contactPoint" inputId="contactPointPM"/>
            <label for="contactPointPM" class="ml-2">Private Message</label>
          </div>
          <input pInputText type="text" placeholder="Others" formControlName="contactPointOther" class="w-48">
        </div>
      </div>
    </section>

    <!-- Travel Details Section -->
    <section class="mb-6">
      <h3 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Travel Details</h3>
      <p-fluid class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
        <p-float-label variant="on">
          <p-input-number inputId="days" formControlName="travelDays" [showButtons]="true"/>
          <label for="days">Days</label>
        </p-float-label>

        <p-float-label variant="on">
          <p-input-number inputId="nights" formControlName="travelNights" [showButtons]="true"/>
          <label for="nights">Nights</label>
        </p-float-label>

        <p-float-label variant="on">
          <input pInputText class="w-full" type="text" formControlName="destination" id="destination">
          <label for="destination">Destination</label>
        </p-float-label>
      </p-fluid>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div formArrayName="dateRanges">
          <label class="text-gray-700 font-semibold block mb-2">Preferred Travel Dates</label>
          <div *ngFor="let _ of dateRanges.controls; let i = index" [formGroupName]="i"
               class="mb-2 grid gap-1 grid-cols-[40%_40%_10%]">
            <p-float-label variant="on">
              <p-date-picker formControlName="start" [showIcon]="true" iconDisplay="input" dateFormat="mm/dd/y" [inputId]="'startDate' + i"/>
              <label for="'startDate' + i">Start Date</label>
            </p-float-label>
            <p-float-label variant="on">
              <p-date-picker formControlName="end" [showIcon]="true" iconDisplay="input" dateFormat="mm/dd/y" [inputId]="'endDate' + i"/>
              <label [for]="'endDate' + i">End Date</label>
            </p-float-label>
            <p-button *ngIf="dateRanges.length > 1" icon="pi pi-times" (click)="removeDateRange(i)" severity="danger"
                      [text]="true" size="small"/>
          </div>
          <p-button icon="pi pi-plus" (click)="addDateRange()" [text]="true" label="Add Date Range" size="small"/>
        </div>
        <div>
          <label class="text-gray-700 font-semibold block mb-2">Preferred Hotel(s)</label>
          <div class="flex items-center">
            <input pInputText type="text" formControlName="preferredHotel" id="preferredHotel" fluid>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <label class="text-gray-700 font-semibold block mb-2">Number of Travelers</label>
        <p-fluid class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <p-float-label variant="on">
            <p-input-number inputId="paxAdult" formControlName="paxAdult" [showButtons]="true"/>
            <label for="paxAdult">Adults</label>
          </p-float-label>
          <p-float-label variant="on">
            <p-input-number formControlName="paxChild" inputId="paxChild" [showButtons]="true"/>
            <label for="paxChild">Child</label>
          </p-float-label>
          <p-float-label variant="on" *ngIf="inquiryForm.controls.paxChild.value">
            <input pInputText type="text" formControlName="paxChildAges" id="paxChildAges">
            <label for="paxChildAges">Child Ages</label>
          </p-float-label>
        </p-fluid>
      </div>
    </section>

    <!-- Package Details Section -->
    <section class="mb-6">
      <h3 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Package Details</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="text-gray-700 font-semibold block mb-2">Package Type</label>
          <div class="grid grid-cols-1 gap-2">
            <div class="flex items-center gap-2">
              <p-radio-button value="allIn" formControlName="packageType" inputId="allIn"/>
              <label for="allIn">All-Inclusive Package</label>
            </div>
            <div class="flex items-center gap-2">
              <p-radio-button value="landArrangement" formControlName="packageType" inputId="landArrangement"/>
              <label for="landArrangement">Land Arrangement Only</label>
            </div>
            <div class="flex items-center gap-2">
              <p-radio-button value="tourOnly" formControlName="packageType" inputId="tourOnly"/>
              <label for="tourOnly">Tour Only</label>
            </div>
            <div class="flex items-center gap-2">
              <p-radio-button value="flightOnly" formControlName="packageType" inputId="flightOnly"/>
              <label for="flightOnly">Flight Only</label>
            </div>
          </div>
        </div>

        <div>
          <label class="text-gray-700 font-semibold block mb-2">Other Services</label>
          <textarea pTextarea formControlName="otherServices" rows="5" class="w-full"></textarea>
        </div>
      </div>
    </section>

    <!-- Pricing & Quotation Section -->
    <section class="mb-6">
      <h3 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Pricing & Quotation</h3>

      <div class="space-y-6">
        <!-- Provider Price List -->
        <div formArrayName="providerQuotations" >
          <label class="text-gray-700 font-semibold block mb-2">Provider Quotations</label>

          <div *ngFor="let provider of providers; let i = index" [formGroupName]="i" class="mb-6 p-4 border rounded-lg bg-white">
            <!-- Provider Header -->
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-4">
                <span class="font-medium text-lg">{{ provider.name }}</span>
                <a [href]="provider.trackerLink" target="_blank"
                   class="text-blue-500 hover:text-blue-700 text-sm">
                  <i class="pi pi-external-link"></i> View Tracker
                </a>
              </div>
              <div class="flex items-center gap-2">
                <p-checkbox formControlName="includeInEmail" [binary]="true"
                            inputId="includeEmail{{i}}"/>
                <label [for]="'includeEmail' + i" class="text-sm text-gray-600">
                  Include in email quotation
                </label>
              </div>
            </div>
            <!-- Show full details only in edit mode -->
            <div *ngIf="isEditMode" class="grid grid-cols-1 md:grid-cols-3 gap-2">
              <div>
                <p-select formControlName="providerStatus"
                          [options]="quotationStatuses"
                          optionLabel="label"
                          optionValue="value"
                          placeholder="Select Status"
                          [styleClass]="'status-dropdown'"
                          class="w-full">
                  <ng-template pTemplate="selectedItem" let-providerStatus>
                    <span [class]="getStatusClass(providerStatus?.value)">{{ providerStatus?.label }}</span>
                  </ng-template>
                  <ng-template pTemplate="item" let-providerStatus>
                    <span [class]="providerStatus.class">{{ providerStatus.label }}</span>
                  </ng-template>
                </p-select>
              </div>

              <div class="flex flex-col gap-2">
                <div class="flex gap-2">
                  <p-select [options]="currencies"
                            formControlName="currency"
                            placeholder="Currency" (onChange)="onCurrencyChange(i)">
                  </p-select>
                  <p-float-label variant="on">
                    <p-input-number fluid [currency]="providerQuotations.at(i).get('currency')?.value || 'PHP'"
                                    mode="currency"
                                    formControlName="price"
                                    [id]="'price-' + i"
                                    (onInput)="onPriceInput(i)" class="w-full"/>
                    <label [for]="'price-' + i">Price</label>
                  </p-float-label>
                </div>
                <div *ngIf="providerQuotations.at(i).get('currency')?.value !== 'PHP'" class="mt-2 space-y-2">
                  <p-inputgroup>
                    <p-float-label variant="on" class="flex-1">
                      <p-input-number mode="decimal"
                                      [minFractionDigits]="2"
                                      [maxFractionDigits]="2"
                                      formControlName="exchangeRate"
                                      [id]="'exchangeRate-' + i"
                                      class="w-full"/>
                      <label [for]="'exchangeRate-' + i">Exchange Rate</label>
                    </p-float-label>
                    <p-inputgroup-addon>
                      <p-button icon="pi pi-refresh"
                                (onClick)="fetchExchangeRate(i)"
                                [loading]="isLoadingRate[i]"
                                [disabled]="!providerQuotations.at(i).get('price')?.value"
                                severity="secondary"
                                [text]="true"/>
                    </p-inputgroup-addon>
                  </p-inputgroup>
                  <p-float-label variant="on">
                    <p-input-number mode="currency"
                                    currency="PHP"
                                    formControlName="phpEquivalent"
                                    [readonly]="true"
                                    [id]="'phpEquivalent-' + i"
                                    class="w-full"/>
                    <label [for]="'phpEquivalent-' + i">PHP Equivalent</label>
                  </p-float-label>
                  <small *ngIf="exchangeRateLastUpdated[i]" class="text-gray-500">
                    Last updated: {{ exchangeRateLastUpdated[i] | date:'medium' }}
                  </small>
                </div>
              </div>

              <div>
                <p-float-label variant="on">
                  <input type="text"
                         [id]="'remarks-' + i"
                         formControlName="remarks"
                         pInputText
                         class="w-full">
                  <label [for]="'remarks-' + i">Remarks</label>
                </p-float-label>
              </div>
            </div>

            <!-- Email Remarks (Conditional) -->
            <div *ngIf="providerQuotations.at(i).get('includeInEmail')?.value"
                 [class.mt-4]="isEditMode"
                 [class.pt-4]="isEditMode"
                 [class.border-t]="isEditMode">
              <p-float-label variant="on">
                  <textarea pTextarea
                            [id]="'emailRemarks-' + i"
                            formControlName="emailRemarks"
                            rows="2"
                            class="w-full"></textarea>
                <label [for]="'emailRemarks-' + i">Remarks to include in email</label>
              </p-float-label>
            </div>
          </div>
        </div>

        <!-- Others Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="flex items-center gap-4">
            <label class="text-gray-700 font-semibold">Quotation submitted to client?</label>
            <div class="flex gap-4">
              <div class="flex items-center">
                <p-radio-button [value]="true" formControlName="submitted" inputId="quotationSubmittedYes"/>
                <label for="quotationSubmittedYes" class="ml-2">Yes</label>
              </div>
              <div class="flex items-center">
                <p-radio-button [value]="false" formControlName="submitted" inputId="quotationSubmittedNo"/>
                <label for="quotationSubmittedNo" class="ml-2">No</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Remarks Section -->
    <section class="mb-6">
      <h3 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Remarks</h3>
      <textarea pTextarea id="remarks" formControlName="remarks" rows="4" class="w-full"></textarea>
    </section>

    <div class="flex justify-center gap-2">
      <p-button type="button" [rounded]="true" severity="info" label="Save" icon="pi pi-save" (onClick)="saveInquiry()"/>
      <p-button type="button" [rounded]="true" severity="success" label="Send" icon="pi pi-send" (onClick)="sendQuotations()"/>
    </div>

    <!-- Audit Information -->
    <div class="mt-8 text-xs text-gray-500 border-t pt-4">
      <div class="grid grid-cols-2 gap-2">
        <div>Created by {{ createdBy.value }} on {{ createdAt.value | date:'medium' }}</div>
        <div>Last updated by {{ updatedBy.value }} on {{ updatedAt.value | date:'medium' }}</div>
      </div>
    </div>
  </form>
</section>

<p-toast></p-toast>
