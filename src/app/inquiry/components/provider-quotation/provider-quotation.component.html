<div class="mb-6 p-4 border rounded-lg bg-white" [formGroup]="formGroup" *ngIf="provider">
  <!-- Provider Header -->
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-4">
      <span class="font-medium text-lg">{{ provider.name }}</span>
      <a [href]="provider.trackerLink" target="_blank"
         class="text-blue-500 hover:text-blue-700 text-sm">
        <i class="pi pi-external-link"></i> View Tracker
      </a>
    </div>
    <div class="flex items-center gap-2">
      <p-button (onClick)="remove()" [text]="true" icon="pi pi-trash" severity="danger"></p-button>
      <p-select [options]="quotationStatuses"
                [styleClass]="'status-dropdown w-[200px]'"
                formControlName="status"
                optionLabel="label"
                optionValue="value"
                placeholder="Select Status">
      </p-select>
    </div>
  </div>

  <div *ngIf="isEditMode" class="space-y-4">
    <!-- Email Section - Show when status is pending -->
    <div *ngIf="showEmailSection" class="p-4 border rounded bg-gray-50">
      <p-float-label variant="on">
          <textarea [id]="'emailRemarks-' + provider.name"
                    class="w-full"
                    formControlName="emailQuotation"
                    pTextarea
                    rows="2"></textarea>
        <label [for]="'emailRemarks-' + provider.name">Remarks to include in email</label>
      </p-float-label>

      <div class="flex justify-end">
        <p-button (onClick)="sendQuotation()" [icon]="isSent ? 'pi pi-search-plus' : 'pi pi-send'"
                  [label]="isSent ? 'Preview' : 'Sent'"
                  [rounded]="true"
                  [severity]="isSent ? 'info' : 'success'" class="transform transition-all duration-300 hover:scale-105"
                  type="button"/>
      </div>
    </div>

    <!-- Pricing Section - Show when status is received -->
    <div *ngIf="showPricingSection" class="p-4 border rounded bg-gray-50">
      <h3 class="font-medium mb-3">Pricing Details</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-3">
          <div class="flex gap-2">
            <p-select (onChange)="onCurrencyChange()"
                      [options]="currencies"
                      [styleClass]="'w-[120px]'"
                      formControlName="currencyCode"
                      placeholder="Currency">
            </p-select>
            <p-float-label class="flex-1" variant="on">
              <p-input-number (onInput)="onPriceInput()"
                              [currency]="formGroup.get('currencyCode')?.value || 'PHP'"
                              [id]="'price-' + provider.name"
                              class="w-full"
                              fluid
                              formControlName="priceAmount"
                              mode="currency"/>
              <label [for]="'price-' + provider.name">Price</label>
            </p-float-label>
          </div>

          <div *ngIf="formGroup.get('currencyCode')?.value !== 'PHP'" class="space-y-3">
            <p-inputgroup>
              <p-float-label class="flex-1" variant="on">
                <p-input-number [id]="'exchangeRate-' + provider.name"
                                [maxFractionDigits]="2"
                                [minFractionDigits]="2"
                                class="w-full"
                                formControlName="exchangeRate"
                                mode="decimal"/>
                <label [for]="'exchangeRate-' + provider.name">Exchange Rate</label>
              </p-float-label>
              <p-inputgroup-addon>
                <p-button (onClick)="fetchExchangeRate()"
                          [disabled]="!formGroup.get('priceAmount')?.value"
                          [loading]="isLoadingRate"
                          [text]="true"
                          icon="pi pi-refresh"
                          severity="secondary"/>
              </p-inputgroup-addon>
            </p-inputgroup>

            <p-float-label variant="on">
              <p-input-number [id]="'phpEquivalent-' + provider.name"
                              [readonly]="true"
                              class="w-full"
                              currency="PHP"
                              formControlName="phpEquivalentAmount"
                              mode="currency"/>
              <label [for]="'phpEquivalent-' + provider.name">PHP Equivalent</label>
            </p-float-label>
            <small *ngIf="exchangeRateLastUpdated" class="text-gray-500">
              Last updated: {{ exchangeRateLastUpdated | date:'medium' }}
            </small>
          </div>
        </div>

        <div class="space-y-3">
          <p-float-label variant="on">
            <input [id]="'remarks-' + provider.name"
                   class="w-full"
                   formControlName="internalRemarks"
                   pInputText
                   type="text">
            <label [for]="'remarks-' + provider.name">Internal Remarks</label>
          </p-float-label>

          <div class="flex justify-end">
            <p-button (onClick)="generateQuotation()"
                      [text]="true"
                      icon="pi pi-file-export"
                      label="Generate Quotation"/>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
