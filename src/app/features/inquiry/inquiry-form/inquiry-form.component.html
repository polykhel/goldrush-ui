<section class="container mx-auto px-4 py-8">
  <form [formGroup]="inquiryForm" class="p-6 shadow-md rounded max-w-4xl border mx-auto bg-white">
    <div class="flex justify-between align-items-center mb-3">
      <p-button (click)="goBack()" [text]="true" icon="pi pi-arrow-left" label="Back"></p-button>
      <h2 class="text-2xl font-bold">{{ editMode ? 'Edit' : 'New' }} Inquiry</h2>
    </div>
    <!-- Basic Information Section -->
    <section class="mb-6">
      <h3 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Basic Information</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <p-float-label variant="on">
          <p-select
            [options]="statusOptions"
            [styleClass]="'w-full'"
            formControlName="status"
            optionLabel="label"
            optionValue="value"
            placeholder="Select Status">
            <ng-template let-status pTemplate="selectedItem">
              <span [class]="status.color">{{status.label}}</span>
            </ng-template>
            <ng-template let-status pTemplate="item">
              <p-fluid>
                <span [class]="status.color">{{status.label}}</span>
              </p-fluid>
            </ng-template>
          </p-select>
          <label for="status">Status</label>
        </p-float-label>

        <p-float-label variant="on">
          <p-date-picker [showIcon]="true" dateFormat="mm-dd-yy" fluid formControlName="date"
                         inputId="date"></p-date-picker>
          <label for="date">Date</label>
        </p-float-label>
      </div>

      <div class="mt-4">
        <p-float-label variant="on">
          <input class="w-full" formControlName="clientName" id="clientName" pInputText type="text">
          <label for="clientName">Client Name</label>
        </p-float-label>
      </div>

      <div class="mt-4" formGroupName="source">
        <label class="text-gray-700 font-semibold block mb-2">Source</label>
        <div class="flex flex-wrap items-center gap-4">
          <div class="flex items-center">
            <p-radio-button formControlName="type" inputId="sourceFB" value="fb"/>
            <label class="ml-2" for="sourceFB">Facebook</label>
          </div>
          <div class="flex items-center">
            <p-radio-button formControlName="type" inputId="sourcePM" value="pm"/>
            <label class="ml-2" for="sourcePM">Private Message</label>
          </div>
          <input class="w-48" formControlName="other" pInputText placeholder="Others"
                 type="text">
        </div>
      </div>
    </section>

    <!-- Travel Details Section -->
    <section class="mb-6" formGroupName="travelDetails">
      <h3 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Travel Details</h3>
      <p-fluid class="grid grid-cols-2 gap-4 mb-4">
        <p-float-label variant="on">
          <p-select [options]="countries" formControlName="countryId" inputId="countryId"
                    optionLabel="name">
            <ng-template pTemplate="dropdownicon">
              <i class="pi pi-map"></i>
            </ng-template>
          </p-select>
          <label for="countryId">Country</label>
        </p-float-label>

        <p-float-label variant="on">
          <input class="w-full" formControlName="destination" id="destination" pInputText
                 type="text">
          <label for="destination">Destination</label>
        </p-float-label>

        <p-float-label variant="on">
          <p-input-number [showButtons]="true" formControlName="days" inputId="days"/>
          <label for="days">Days</label>
        </p-float-label>

        <p-float-label variant="on">
          <p-input-number [showButtons]="true" formControlName="nights" inputId="nights"/>
          <label for="nights">Nights</label>
        </p-float-label>
      </p-fluid>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-gray-700 font-semibold block mb-2">Travel Dates</label>
          <div class="grid gap-4 grid-cols-2">
            <p-float-label variant="on">
              <p-date-picker [showIcon]="true" dateFormat="mm/dd/y" formControlName="startDate" iconDisplay="input"/>
              <label for="startDate">Start Date</label>
            </p-float-label>
            <p-float-label variant="on">
              <p-date-picker [showIcon]="true" dateFormat="mm/dd/y" formControlName="endDate" iconDisplay="input"/>
              <label for="endDate">End Date</label>
            </p-float-label>
          </div>
        </div>
        <div>
          <label class="text-gray-700 font-semibold block mb-2">Preferred Hotel(s)</label>
          <div class="flex items-center">
            <input fluid formControlName="preferredHotel" id="preferredHotel" pInputText type="text">
          </div>
        </div>
      </div>

      <div class="mt-4">
        <label class="text-gray-700 font-semibold block mb-2">Number of Travelers</label>
        <p-fluid class="grid grid-cols-2 gap-4">
          <p-float-label variant="on">
            <p-input-number [showButtons]="true" formControlName="adults" inputId="adults"/>
            <label for="adults">Adults</label>
          </p-float-label>
          <p-float-label variant="on">
            <p-input-number [showButtons]="true" formControlName="children" inputId="children"/>
            <label for="children">Children</label>
          </p-float-label>
        </p-fluid>
      </div>
    </section>

    <!-- Package Details Section -->
    <section class="mb-6">
      <h3 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Package Details</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="text-gray-700 font-semibold block mb-2">Package Type</label>
          <div class="grid grid-cols-1 gap-2">
            <div class="flex items-center gap-2">
              <p-radio-button formControlName="packageType" inputId="allInclusive"
                              value="all-inclusive"/>
              <label for="allInclusive">All-Inclusive Package</label>
            </div>
            <div class="flex flex-col gap-2">
              <div class="flex items-center gap-2">
                <p-radio-button formControlName="packageType" inputId="custom" value="custom"/>
                <label for="custom">Custom Package</label>
              </div>
              <div *ngIf="inquiryForm.controls.packageType.value === 'custom'"
                   class="ml-6 flex flex-col gap-2">
                <div *ngFor="let option of packageOptions" class="flex items-center gap-2">
                  <p-checkbox
                    [formControlName]="'customPackageOptions'"
                    [inputId]="option.id"
                    [value]="option.id">
                  </p-checkbox>
                  <label [for]="option.id" class="ml-2"> {{ option.label }} </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Pricing & Quotation Section -->
    <section class="mb-6">
      <h3 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Pricing & Quotation</h3>

      <div class="space-y-6">
        <!-- Provider Price List -->
        <div formArrayName="providerQuotations">
          <label class="text-gray-700 font-semibold block mb-2">Provider Quotations</label>

          <app-provider-quotation (onAddGroup)="addGroupToFormArray($event)"
                                  (onGenerateQuotation)="generateQuotation($event)"
                                  *ngFor="let provider of providers"
                                  [existingProviderQuotation]="getProviderQuotation(provider.documentId!)"
                                  [isEditMode]="editMode"
                                  [provider]="provider">
          </app-provider-quotation>
        </div>
      </div>
    </section>

    <!-- Remarks Section -->
    <section class="mb-6">
      <h3 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Remarks</h3>
      <textarea class="w-full" formControlName="remarks" id="remarks" pTextarea rows="4"></textarea>
    </section>

    <div class="flex justify-center gap-2">
      <p-button (onClick)="saveInquiry()" [loading]="saving" [rounded]="true" icon="pi pi-save"
                label="Save" severity="info"
                type="button"/>
      <p-button (onClick)="sendQuotations()" [rounded]="true" icon="pi pi-send" label="Send"
                severity="success"
                type="button"/>
    </div>

    <!-- Audit Information -->
    <div class="mt-8 text-xs text-gray-500 border-t pt-4">
      <div class="grid grid-cols-2 gap-2">
        <div>Created by {{ creator.value }} on {{ createdAt | date:'medium' }}</div>
        <div>Last updated by {{ modifier.value }} on {{ updatedAt | date:'medium' }}</div>
      </div>
    </div>

    <app-email-preview-modal
      (cancel)="showEmailPreview = false"
      (send)="handleSendEmails()"
      [(visible)]="showEmailPreview"
      [emailData]="emailData"
      [isSending]="isSending"
      [providerQuotations]="providerQuotations.value"
      [providers]="providerMap"
    ></app-email-preview-modal>
  </form>
  <p-toast></p-toast>
</section>
